name: CI-CD Pipeline

on:
  push:
    paths:
      - 'data/raw/**'
    branches:
      - master

jobs:
  train-and-save:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ---------- Set MLflow / DagsHub environment ----------
      - name: Set MLflow and DagsHub Env
        run: |
          echo "MLFLOW_TRACKING_URI=${{ secrets.MLFLOW_TRACKING_URI }}" >> $GITHUB_ENV
          echo "MLFLOW_TRACKING_USERNAME=${{ secrets.MLFLOW_TRACKING_USERNAME }}" >> $GITHUB_ENV
          echo "DAGSHUB_TOKEN=${{ secrets.DAGSHUB_TOKEN }}" >> $GITHUB_ENV

      # ---------- Stage 1 ----------
      - name: Run Stage 1 - Data Ingestion
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: python -m src.stage_01_data_ingestion

      # ---------- Stage 2 ----------
      - name: Run Stage 2 - Data Validation
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: python -m src.stage_02_data_validation

      # ---------- Stage 3 ----------
      - name: Run Stage 3 - Data Transformation
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: python -m src.stage_03_data_transformation

      # ---------- Stage 4 ----------
      - name: Run Stage 4 - Model Training
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: python -m src.stage_04_model_trainer

      # ---------- Upload Artifacts ----------
      - name: Upload Artifacts to Actions
        uses: actions/upload-artifact@v4
        with:
          name: all_artifacts
          path: |
            artifacts/best_model/
            artifacts/best_model_evaluation_report.json
            logs/
            reports/

      # ---------- Auto-commit artifacts ----------
      - name: Commit and Push Updated Artifacts
        if: success()
        run: |
          git config --global user.name "Bhagirath55"
          git config --global user.email "21fycs.a20.bhagirath@gmail.com"

          # Safely add artifacts if they exist
          git add artifacts/best_model.pkl || true
          git add artifacts/best_model/ || true
          git add artifacts/best_model_evaluation_report.json || true
          git add logs/ || true
          git add reports/ || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update artifacts, logs, and best model [Automated CI/CD]"
            git pull --rebase origin master
            git push origin master
          fi
